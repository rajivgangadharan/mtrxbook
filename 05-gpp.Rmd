# Global Pay Plus (GPP)

## Delivery Metrics 


```{r gpp-setup, include=FALSE}
source("./R/common.R")
```

```{r gpp-delivery-setup, include=FALSE}

# Create the tibble
tib.all <-
  finmetrics::get.FilteredTibble(here::here("inst/extdata",
                                            "gpp_delivery.csv"),
                                 date_from = Sys.Date() - months(12))

tib <- tib.all %>%
  finmetrics::exclude.OpenCases() %>% 
  finmetrics::compute.CycleTime() %>%
  finmetrics::compute.Week()

tib.all$Priority <- 
  factor(tib.all$Priority, 
                           levels=c("Critical",
                                    "High", 
                                    "Medium", 
                                    "Low", 
                                    "None"), 
                           ordered = TRUE)

# Collecting only stories, filtering out abnormalities
stories.closed <- tib %>% filter(cldt > crdt) %>% filter(Type == "Story")
# Collecting only Epics, filtering out abnormalities
epics.closed <- tib %>% filter(cldt > crdt) %>% filter(Type == "Epic")
```

###  Cycle Time


#### Summary

The below [Five-number summary](https://en.wikipedia.org/wiki/Five-number_summary) will provide a high level distribution of the cycle times. 

```{r gpp-cycle-time-summ, include=TRUE, out.width='80%', echo=FALSE}
tabulate.TypeAndPriorityBasedCycleTimeStat(tib)
```

#### Epics


```{r gpp-epics-cycle-time-trend-fig, include=TRUE, out.width='80%', fig.asp=.75, fig.align='center', fig.cap="Cycle Time Trend", echo=FALSE}
loess_plot.CycleTimeTrend(epics.closed, col_date="crdt")
```


```{r gpp-epics-summary-metrics, include=TRUE, out.width='80%', echo=FALSE}
 tabulate.PriorityBasedCycleTimeStat(epics.closed)
```

#### Stories

```{r gpp-stories-cycle-time-trend-fig, include=TRUE, out.width='80%', fig.asp=.75, fig.align='center', fig.cap="Cycle Time Trend", echo=FALSE}

loess_plot.CycleTimeTrend(stories.closed, col_date="crdt")

```


```{r gpp-story-summary-metrics, include=TRUE, out.width='80%', echo=FALSE}

tabulate.PriorityBasedCycleTimeStat(stories.closed)

```

### Throughput

#### Epics

```{r gpp-completed-epics-week-fig, out.width='80%', fig.asp=.75, fig.align='center', fig.cap = "Closed Epics by Week", echo=FALSE}

line_plot.NumClosed_For_FloorDate(
  gen_ds.NumClosed_For_FloorDate(epics.closed)
)

```

The plot below shows the number of epics closed in every week, marked separately in different color based on priority

```{r gpp-epics-wk-agg-fig, include=TRUE, out.width='80%', fig.asp=.75, fig.align='center', echo=FALSE}

bar_plot.NumClosed_For_FloorDate(
  gen_ds.NumClosed_For_FloorDate(epics.closed, priority_based=TRUE)
)

```

- Density distribution

Gives and indication of the densities especially the occurrence of multiple maxima in the data. This can be due to multiple categories of work items which may be investigated further. 

```{r gpp-density-distibution-closed-epics-fig, include=TRUE, echo=FALSE, out.width="80%", fig.align="center", fig.asp=.75, fig.cap="Priority based Density Distribution", message=FALSE, warning=FALSE}
epics.closed %>% violin_plot.CycleTimeVsPriority(pal_option = 'D')
```


#### Stories


Tells us the number of work items (stories) completed aggregated for each 
week which is an indication of how stable the throughput is.

```{r gpp-completed-items-week-fig, out.width='80%', fig.asp=.75, fig.align='center', echo=FALSE}

line_plot.NumClosed_For_FloorDate(
  gen_ds.NumClosed_For_FloorDate(stories.closed)
)

```

The plot below shows the number of stories closed in every week, marked separately in different color based on priority


```{r gpp-stories-wk-agg-fig, include=TRUE, out.width='80%', fig.asp=.75, fig.align='center', fig.cap="Number of Stories Closed in a Week colored by Priority", echo=FALSE}

bar_plot.NumClosed_For_FloorDate(
  gen_ds.NumClosed_For_FloorDate(stories.closed, priority_based=TRUE)
)

```

- Density distribution

Gives and indication of the densities especially the occurrence of multiple maxima in the data. This can be due to multiple categories of work items which may be investigated further. 

```{r gpp-density-distibution-closed-stories-fig, include=TRUE, echo=FALSE, out.width="80%", fig.align="center", fig.asp=.75, fig.cap="Priority based Density Distribution", message=FALSE, warning=FALSE}

stories.closed %>% violin_plot.CycleTimeVsPriority(pal_option = 'D')

```


### Flow

#### Work in Progress (WiP)

##### Epics 

```{r gpp-epics-work-in-progress, include=TRUE, echo=FALSE}
tib_epics_work_in_progress <- tib.all %>%
  dplyr::filter(Type == 'Epic') %>% finmetrics::compute.WIP()

```

```{r gpp-epics-work-in-progress-fig , include=TRUE, echo=FALSE, out.width='80%', fig.asp=.75, fig.cap="WiP in Days", fig.align='center', cache=TRUE}
ggplot(tib_epics_work_in_progress,
  aes(x = Date, y = WIPInDays)
) +
  geom_area(fill = viridis(1)) +
  xlab("Dates") + ylab("WiP (Days)") +
  scale_x_date(date_labels = "%b/%y", date_breaks = "8 weeks") +
  scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

##### Stories

```{r gpp-stories-work-in-progress, include=TRUE, echo=FALSE}
tib_stories_work_in_progress <- tib.all %>%
  dplyr::filter(Type == 'Story') %>% finmetrics::compute.WIP()

```

```{r gpp-stories-work-in-progress-fig , include=TRUE, echo=FALSE, out.width='80%', fig.asp=.75, fig.cap="WiP in Days", fig.align='center', cache=TRUE}
ggplot(tib_stories_work_in_progress,
  aes(x = Date, y = WIPInDays)
) +
  geom_area(fill = viridis(1)) +
  xlab("Dates") + ylab("WiP (Days)") +
  scale_x_date(date_labels = "%b/%y", date_breaks = "8 weeks") +
  scale_fill_viridis(discrete = TRUE, option = "D") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

#### Inflow/OutFlow

##### Epics

```{r gpp-epics-inflow-outflow, include=TRUE, echo=FALSE, out.width='80%', fig.align="center", fig.asp=.75, eval=TRUE}
flow.epics.merged <- tib.all %>%
  get.InflowOutflowTibble.Epic(include_priority = TRUE)
 bar_plot.InflowOutflow(flow.epics.merged)
```

```{r gpp-epics-inflow-outflow-cumsumm, include=TRUE, echo=FALSE, out.width='80%', fig.asp=.75, fig.align="center", eval=TRUE}
line_plot.InflowOutflow.CumSum(flow.epics.merged)
```

##### Stories

```{r gpp-stories-inflow-outflow, include=TRUE, echo=FALSE, out.width='80%', fig.asp=.75, fig.align='center',  eval=TRUE}
flow.stories.merged <- tib.all %>%
  get.InflowOutflowTibble.Story(include_priority = TRUE)
 bar_plot.InflowOutflow(flow.stories.merged)
```

```{r gpp-stories-inflow-outflow-cumsumm, out.width='80%', fig.asp=.75, fig.align='center',include=TRUE, echo=FALSE, eval=TRUE}
line_plot.InflowOutflow.CumSum(flow.stories.merged)
```

## Defect Metrics

```{r gpp-defects-setup, include=FALSE}
# Empty
```


```{r gpp-defect-metrics-setup, echo=FALSE, include=TRUE, message=FALSE, warning=FALSE}
tib_defects.all <-
  finmetrics::get.FilteredTibble(here::here("inst/extdata",
                                            "gpp_defects.csv"),
                                 date_from = Sys.Date() - months(12)) %>%
  filter(Type == "Defect")

tib_defects.all$Priority <- factor(
  tib_defects.all$Priority,
  levels = c("Critical", "High", "Medium", "Low", "NA"),
  ordered = TRUE
)

tib_defects.closed <-
  tib_defects.all %>% finmetrics::exclude.OpenCases() %>% 
  finmetrics::compute.CycleTime() %>% finmetrics::compute.Week()

tib_defects.closed.high_and_critical <- tib_defects.closed %>% 
  filter(Priority == "High" | Priority == "Critical")
```

###  Cycle Time

Below is the [5 Number Summary](https://en.wikipedia.org/wiki/Five-number_summary) of the entire data set. The 75% Qartile value is significant because that is the number which you can typically see as the turn around time (TAT) to service a defect.

#### Summary

```{r gpp-defects-tab-cycle-time-basic-stats, out.width="80%", echo=FALSE, include=TRUE}

tabulate.CycleTimeStat(tib_defects.closed, tab_caption = "5 Number Summary")

```


#### Cycle Time Trend

```{r gpp-defects-cycle-time-trend-all, include=TRUE, echo=FALSE , out.width='80%', fig.asp=.75, fig.align='center', fig.cap="All Severities"}
loess_plot.CycleTimeTrend(tib_defects.closed, plt_caption="Reflects ability of the team to resolve across all severities")
```


#### 5 Number Summary

```{r gpp-defects-cycle-time-summary, include=TRUE, out.width='80%', echo=FALSE}
tabulate.PriorityBasedCycleTimeStat(tib_defects.closed,
                                    tab_caption = "All Severities")
```

```{r gpp-defects-cycle-time-trend-for-hnc, include=TRUE, echo=FALSE , out.width='80%', fig.asp=.75, fig.align='center', fig.cap="High and Critical"}

loess_plot.CycleTimeTrend(tib_defects.closed.high_and_critical, plt_caption="Ability to focus on High and Critical Severities")

```


```{r gpp-defects-cycle-time-stat-for-high-and-critical, include=TRUE, echo=FALSE }
tabulate.PriorityBasedCycleTimeStat(tib_defects.closed.high_and_critical, tab_caption="5 Number Summary for High and Critical Defects")
```


### Throughput


```{r gpp-defects-closed-metric-for-each-week, include=TRUE, echo=FALSE, out.width="80%", fig.asp=0.75, fig.align='center', fig.cap="Closure metrics - All Defects"}
defects_ncount_by_week <-
  gen_ds.NumClosed_For_FloorDate(tib_defects.closed)

  line_plot.NumClosed_For_FloorDate(defects_ncount_by_week, plt_caption="Closure per Week for All Defects", pal_option="B")
```


```{r gpp-defects-fig-completed-hnc-defects-week, out.width='80%', fig.asp=.75, fig.align='center', fig.cap = "Closed defects by Week", echo=FALSE}
hnc_defects_ncount_by_week <-
  gen_ds.NumClosed_For_FloorDate(tib_defects.closed.high_and_critical)
line_plot.NumClosed_For_FloorDate(hnc_defects_ncount_by_week, plt_caption="Closure per Week - High and Critical Defects")
```

```{r gpp-defects-wk-agg, include=TRUE, echo=FALSE}
tib_defects_wk_agg <-
  tib_defects.closed %>%
  gen_ds.NumClosed_For_FloorDate(priority_based = TRUE)

tib_hnc_defects_wk_agg <-
  tib_defects.closed.high_and_critical %>%
  gen_ds.NumClosed_For_FloorDate(priority_based = TRUE)
```


The plot below shows the number of defects closed in every week, marked separately in different color based on priority


```{r gpp-defects-all-wk-agg-fig, include=TRUE, echo=FALSE, out.width="80%", fig.caption="Closure Count - All Priorities", fig.asp=0.75, fig.align="center"}
bar_plot.NumClosed_For_FloorDate(tib_defects_wk_agg)
```

```{r gpp-defects-fig-hnc-wk-agg, include=TRUE, echo=FALSE, out.width="80%", fig.caption="Closure Count - High and Critical Priorities", fig.asp=0.75, fig.align="center"}
bar_plot.NumClosed_For_FloorDate(tib_hnc_defects_wk_agg)
```

```{r gpp-defects-tab-weekly-aggregate, echo=FALSE}
DT::datatable(tib_defects_wk_agg, filter='top')
```

- Density distribution

Gives and indication of the densities especially the occurrence of multiple maxima in the data. This can be due to multiple categories of work items which may be investigated further. Below are the violin plots for all defects and also high and critical defects.

```{r gpp-defects-fig-densdist-closed-overall, include=TRUE, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Priority based Density Distribution", message=FALSE, warning=FALSE}
tib_defects.closed %>% violin_plot.CycleTimeVsPriority(pal_option = 'B')
```

```{r gpp-defects-fig-densdist-closed-hnc, include=TRUE, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Priority based Density Distribution", message=FALSE, warning=FALSE}
# tib_defects.closed.high_and_critical %>% violin_plot.CycleTimeVsPriority(pal_option = 'B')
```

### Flow

#### Work in Progress (WiP)

```{r gpp-defects-fig-areaplot-wip, include=TRUE, echo=FALSE, out.width="80%", fig.asp=.75, fig.caption="Work in Progress", fig.align='center', cache=TRUE}
  tib_defects_work_in_progress <- tib_defects.all %>%
    dplyr::filter(Type == 'Defect') %>% finmetrics::compute.WIP()

  ggplot(tib_defects_work_in_progress,
         aes(x = Date, y = WIPInDays)
  ) +
    geom_area(fill = viridis(1)) +
    xlab("Dates") + ylab("WiP (Days)") +
    scale_x_date(date_labels = "%b/%y", date_breaks = "8 weeks") +
    scale_fill_viridis(discrete = TRUE, option = "B") +
    theme_minimal() +
    theme(legend.position = "bottom")
```

#### Inflow Outflow

```{r gpp-defects-inflow-outflow, include=TRUE, echo=FALSE,out.width='80%', fig.asp=.75, fig.align='center', eval=TRUE}
flow.defects.merged <- tib_defects.all %>%
  get.InflowOutflowTibble.Defect(include_priority = TRUE)
bar_plot.InflowOutflow(flow.defects.merged)
```

```{r gpp-defects-inflow-outflow-cumsumm, include=TRUE, echo=FALSE, out.width='80%', fig.asp=.75, fig.align='center',eval=TRUE}
line_plot.InflowOutflow.CumSum(flow.defects.merged)
```
